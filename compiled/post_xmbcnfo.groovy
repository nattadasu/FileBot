{ source, target, metadata -> if (type.toString() != "Episode" && !f.video) {return null};def xNc = target.dir;def SA = any{ s } { 0 };def EB = any{ e } { special };def LVk = 0;def Ckr = null;try {if (db.TheTVDB?.id) {def KKb = "https://api.tvmaze.com";def WC = curl "$KKb/lookup/shows?thetvdb=${db.TheTVDB.id}";def YL = WC.id;Ckr = curl "$KKb/shows/$YL/episodebynumber?season=$SA&number=$EB";LVk = Ckr.id}} catch (Exception err) {};def HyT = "";def aM = "en-US";def Lr = null;def QQT = new File("$home/.filebotsecrets.json");if (QQT.exists()) {def _MW = new groovy.json.JsonSlurper().parseText(QQT.text);HyT = _MW.HyT;aM = _MW.language;Lr = _MW.person_info_dir};def a_A = "https://api.themoviedb.org/3/tv/$id/season/$SA/episode/$EB";def zc = ["accept": "application/json"];def Dq = curl(zc, "$a_A?language=$aM&api_key=$HyT");def BsB = curl(zc, "$a_A/external_ids?api_key=$HyT");def Nm = curl(zc, "$a_A/credits?language=$aM&api_key=$HyT");def CHn = curl(zc, "$a_A/images?include_image_language=en%2Cnull&api_key=$HyT");def gF = (xNc / target.nameWithoutExtension + "-thumb.jpg").toString();def gkj = new File(gF);def VU = new File(gF.replace("-thumb",""));if (!(gkj.exists() || VU.exists()) && CHn.stills.size() > 0) {def KgL = "https://image.tmdb.org/t/p/original${CHn.stills[0].file_path}";system "curl", "-o", xNc / target.nameWithoutExtension + "-thumb.jpg", KgL};def dJk = [];(Nm.cast + Nm.guest_stars).eachWithIndex { Qw, NTE -> def fL = "$Lr/${Qw.name[0]}/${Qw.name}";def bpa = Qw.order ?: NTE + dJk.size();dJk << [Eo: Qw.name, TW: Qw.character, fj: bpa, fL: "${fL}/folder.jpg"];if (Lr) {def cTQ = new File(fL);if (!cTQ.exists()) {cTQ.mkdirs();system "curl", "-o", "${fL}/folder.jpg", "https://image.tmdb.org/t/p/original${Qw.profile_path}"}}};def zwr = xNc / target.nameWithoutExtension + ".nfo";XML(zwr) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(Dq.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (BsB?.imdb_id) {uniqueid(type: "imdb", value: BsB.imdb_id, BsB.imdb_id);imdbid(BsB.imdb_id)};if (BsB?.tvdb_id) {uniqueid(type: "tvdb", value: BsB.tvdb_id, BsB.tvdb_id);tvdbid(BsB.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (LVk) {uniqueid(type: "tvmaze", value: LVk, LVk);tvmazeid(LVk)}} catch (Exception err) {};if (gkj.exists()) {art {poster(gF)}};dJk.each { Lzw ->  actor {name(Lzw.Eo);role(Lzw.TW);sortorder(Lzw.fj);if (Lr) { thumb(Lzw.fL) }}};showtitle(n);episode(EB);season(SA);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { lQp ->  video {def Fn = Float.parseFloat(lQp.'Duration');codec(lQp.'Format');micodec(lQp.'Format');bitrate(lQp.'BitRate');width(lQp.'Width');height(lQp.'Height');aspect(lQp.'DisplayAspectRatio/String');aspectratio(lQp.'DisplayAspectRatio/String');framerate(lQp.'FrameRate');'default'(lQp.'Default' == "Yes" ? "True" : "False");forced(lQp.'Forced' == "Yes" ? "True" : "False");duration(lQp.'Duration' ? (int) Math.floor(Fn / 60000) : 0);durationinseconds(lQp.'Duration' ? (int) Math.floor(Fn / 1000) : 0)}};target.mediaInfo.Audio.each { TL ->  audio {codec(TL.'Format');micodec(TL.'Format');language(TL.'Language/String3');channels(TL.'Channel(s)');samplingrate(TL.'SamplingRate');'default'(TL.'Default' == "Yes" ? "True" : "False");forced(TL.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { YCa ->  subtitle {codec(YCa.'Format');micodec(YCa.'Format');width('0');height('0');language(YCa.'Language/String3');'default'(YCa.'Default' == "Yes" ? "True" : "False");forced(YCa.'Forced' == "Yes" ? "True" : "False")}}}}}}}