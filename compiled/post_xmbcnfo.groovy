{ source, target, metadata ->  if (type.toString() != "Episode" && !f.video) {return null};def GR = target.dir;def bW = any{ s } { 0 };def Dr = any{ e } { special };def CO = 0;def tc = null;try {if (db.TheTVDB?.id) {def bwg = "https://api.tvmaze.com";def kpn = curl "$bwg/lookup/shows?thetvdb=${db.TheTVDB.id}";def Bm = kpn.id;tc = curl "$bwg/shows/$Bm/episodebynumber?season=$bW&number=$Dr";CO = tc.id}} catch (Exception err) {};def kcx = "";def Lf = "en-US";def Jpd = null;def Fl = new File("$home/.filebotsecrets.json");if (Fl.exists()) {def VaP = new groovy.json.JsonSlurper().parseText(Fl.text);kcx = VaP.kcx;Lf = VaP.language;Jpd = VaP.person_info_dir};def Hwl = "https://api.themoviedb.org/3/tv/$id/season/$bW/episode/$Dr";def NQ = ["accept": "application/json"];def SIg = curl(NQ, "$Hwl?language=$Lf&api_key=$kcx");def YDF = curl(NQ, "$Hwl/external_ids?api_key=$kcx");def Ln = curl(NQ, "$Hwl/credits?language=$Lf&api_key=$kcx");def zPt = curl(NQ, "$Hwl/images?include_image_language=en%2Cnull&api_key=$kcx");def eLh = (GR / target.nameWithoutExtension + "-thumb.jpg").toString();def OCq = new File(eLh);def qxA = new File(eLh.replace("-thumb",""));if (!(OCq.exists() || qxA.exists()) && zPt.stills.size() > 0) {def Nd = "https://image.tmdb.org/t/p/original${zPt.stills[0].file_path}";system "curl", "-o", GR / target.nameWithoutExtension + "-thumb.jpg", Nd};def Up = [];(Ln.cast + Ln.guest_stars).eachWithIndex { pFd, VgO ->  def Js = "$Jpd/${pFd.name[0]}/${pFd.name}";def KR = pFd.order ?: VgO + Up.size();Up << [kZr: pFd.name, xL: pFd.character, PX: KR, Js: "${Js}/folder.jpg"];if (Jpd) {def LWA = new File(Js);if (!LWA.exists()) {LWA.mkdirs();system "curl", "-o", "${Js}/folder.jpg", "https://image.tmdb.org/t/p/original${pFd.profile_path}"}}};def fkX = GR / target.nameWithoutExtension + ".nfo";XML(fkX) {mkp.xmlDeclaration(version: "1.0", encoding: "utf-8", standalone: "yes");episodedetails {plot(SIg.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));title(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type: "tmdb", value: episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (YDF?.imdb_id) {uniqueid(type: "imdb", value: YDF.imdb_id, YDF.imdb_id);imdbid(YDF.imdb_id)};if (YDF?.tvdb_id) {uniqueid(type: "tvdb", value: YDF.tvdb_id, YDF.tvdb_id);tvdbid(YDF.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type: "anidb", value: db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (CO) {uniqueid(type: "tvmaze", value: CO, CO);tvmazeid(CO)}} catch (Exception err) {};if (OCq.exists()) {art {poster(eLh)}};Up.each { MK ->  actor {name(MK.kZr);role(MK.xL);sortorder(MK.PX);if (Jpd) { thumb(MK.Js) }}};showtitle(n);episode(Dr);season(bW);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { EWJ ->  video {def SU = Float.parseFloat(EWJ.'Duration');codec(EWJ.'Format');micodec(EWJ.'Format');bitrate(EWJ.'BitRate');width(EWJ.'Width');height(EWJ.'Height');aspect(EWJ.'DisplayAspectRatio/String');aspectratio(EWJ.'DisplayAspectRatio/String');framerate(EWJ.'FrameRate');'default'(EWJ.'Default' == "Yes" ? "True" : "False");forced(EWJ.'Forced' == "Yes" ? "True" : "False");duration(EWJ.'Duration' ? (int) Math.floor(SU / 60000) : 0);durationinseconds(EWJ.'Duration' ? (int) Math.floor(SU / 1000) : 0)}};target.mediaInfo.Audio.each { rhq ->  audio {codec(rhq.'Format');micodec(rhq.'Format');language(rhq.'Language/String3');channels(rhq.'Channel(s)');samplingrate(rhq.'SamplingRate');'default'(rhq.'Default' == "Yes" ? "True" : "False");forced(rhq.'Forced' == "Yes" ? "True" : "False")}};target.mediaInfo.Text.each { AHi ->  subtitle {codec(AHi.'Format');micodec(AHi.'Format');width('0');height('0');language(AHi.'Language/String3');'default'(AHi.'Default' == "Yes" ? "True" : "False");forced(AHi.'Forced' == "Yes" ? "True" : "False")}}}}}}}