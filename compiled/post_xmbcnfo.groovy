{ source, target, metadata ->if (type.toString()!="Episode"&&!f.video) {return null};def gS = target.dir;def Fa = any{ s } { 0 };def Gq = any{ e } { special };def z_d = 0;def EwD = null;try {if (db.TheTVDB?.id) {def kkd = "https://api.tvmaze.com";def rpz = curl "$kkd/lookup/shows?thetvdb=${db.TheTVDB.id}";def Ig = rpz.id;EwD = curl "$kkd/shows/$Ig/episodebynumber?season=$Fa&number=$Gq";z_d = EwD.id}} catch (Exception err) {};def aA = "";def vu = "en-US";def zp = null;def biF = new File("$home/.filebotsecrets.json");if (biF.exists()) {def KU = new groovy.json.JsonSlurper().parseText(biF.text);aA = KU.aA;vu = KU.language;zp = KU.person_info_dir};def TJ = "https://api.themoviedb.org/3/tv/$id/season/$Fa/episode/$Gq";def BYT = ["accept": "application/json"];def DKi = curl(BYT, "$TJ?language=$vu&api_key=$aA");def UcP = curl(BYT, "$TJ/external_ids?api_key=$aA");def FP = curl(BYT, "$TJ/credits?language=$vu&api_key=$aA");def up = curl(BYT, "$TJ/images?include_image_language=en%2Cnull&api_key=$aA");def bqv = (gS / target.nameWithoutExtension + "-thumb.jpg").toString();def rWg = new File(bqv);def MW = new File(bqv.replace("-thumb",""));if (!(rWg.exists()||MW.exists())&&up.stills.size()>0) {def lP = "https://image.tmdb.org/t/p/original${up.stills[0].file_path}";system "curl", "-o", gS / target.nameWithoutExtension + "-thumb.jpg", lP};def nS = [];(FP.cast + FP.guest_stars).eachWithIndex { UAW, Gr ->def fHM = "$zp/${UAW.name[0]}/${UAW.name}";def Fwm = UAW.order?: Gr + nS.size();nS<<[ZgQ:UAW.name,IR:UAW.character,En:Fwm,fHM:"${fHM}/folder.jpg"];if (zp) {def kc = new File(fHM);if (!kc.exists()) {kc.mkdirs();system "curl", "-o", "${fHM}/folder.jpg", "https://image.tmdb.org/t/p/original${UAW.profile_path}"}}};def FBk = gS / target.nameWithoutExtension + ".nfo";XML(FBk) {mkp.xmlDeclaration(Mg:"1.0",encoding:"utf-8",standalone:"yes");episodedetails {plot(DKi.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));lw(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type:"tmdb",value:episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (UcP?.imdb_id) {uniqueid(type:"imdb",value:UcP.imdb_id, UcP.imdb_id);imdbid(UcP.imdb_id)};if (UcP?.tvdb_id) {uniqueid(type:"tvdb",value:UcP.tvdb_id, UcP.tvdb_id);tvdbid(UcP.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type:"anidb",value:db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (z_d) {uniqueid(type:"tvmaze",value:z_d, z_d);tvmazeid(z_d)}} catch (Exception err) {};if (rWg.exists()) {art {poster(bqv)}};nS.each { Ytg ->actor {name(Ytg.ZgQ);role(Ytg.IR);sortorder(Ytg.En);if (zp) { thumb(Ytg.fHM) }}};showtitle(n);episode(Gq);season(Fa);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { nuA ->video {def _k = Float.parseFloat(nuA.'Duration');codec(nuA.'Format');micodec(nuA.'Format');bitrate(nuA.'BitRate');width(nuA.'Width');height(nuA.'Height');aspect(nuA.'DisplayAspectRatio/String');aspectratio(nuA.'DisplayAspectRatio/String');framerate(nuA.'FrameRate');'default'(nuA.'Default'=="Yes"?"True" : "False");forced(nuA.'Forced'=="Yes"?"True" : "False");duration(nuA.'Duration'?(int) Math.floor(_k / 60000) : 0);durationinseconds(nuA.'Duration'?(int) Math.floor(_k / 1000) : 0)}};target.mediaInfo.Audio.each { PV ->audio {codec(PV.'Format');micodec(PV.'Format');language(PV.'Language/String3');channels(PV.'Channel(s)');samplingrate(PV.'SamplingRate');'default'(PV.'Default'=="Yes"?"True" : "False");forced(PV.'Forced'=="Yes"?"True" : "False")}};target.mediaInfo.Text.each { Smn ->subtitle {codec(Smn.'Format');micodec(Smn.'Format');width('0');height('0');language(Smn.'Language/String3');'default'(Smn.'Default'=="Yes"?"True" : "False");forced(Smn.'Forced'=="Yes"?"True" : "False")}}}}}}}