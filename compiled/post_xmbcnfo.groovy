{ source, target, metadata ->if (type.toString()!="Episode"&&!f.video) {return null};def iFO = target.dir;def bVT = any{ s } { 0 };def alc = any{ e } { special };def fv = 0;def PHn = null;try {if (db.TheTVDB?.id) {def Rfs = "https://api.tvmaze.com";def zf = curl "$Rfs/lookup/shows?thetvdb=${db.TheTVDB.id}";def tM = zf.id;PHn = curl "$Rfs/shows/$tM/episodebynumber?season=$bVT&number=$alc";fv = PHn.id}} catch (Exception err) {};def SC = "";def kEp = "en-US";def hY = null;def cM = new File("$home/.filebotsecrets.json");if (cM.exists()) {def km = new groovy.json.JsonSlurper().parseText(cM.text);SC = km.SC;kEp = km.language;hY = km.person_info_dir};def Qu = "https://api.themoviedb.org/3/tv/$id/season/$bVT/episode/$alc";def kgR = ["accept": "application/json"];def tCp = curl(kgR, "$Qu?language=$kEp&api_key=$SC");def Gnr = curl(kgR, "$Qu/external_ids?api_key=$SC");def hS = curl(kgR, "$Qu/credits?language=$kEp&api_key=$SC");def pKy = curl(kgR, "$Qu/images?include_image_language=en%2Cnull&api_key=$SC");def vQ = (iFO / target.nameWithoutExtension + "-thumb.jpg").toString();def Je = new File(vQ);def CTZ = new File(vQ.replace("-thumb",""));if (!(Je.exists()||CTZ.exists())&&pKy.stills.size()>0) {def wS = "https://image.tmdb.org/t/p/original${pKy.stills[0].file_path}";system "curl", "-o", iFO / target.nameWithoutExtension + "-thumb.jpg", wS};def wYT = [];(hS.cast + hS.guest_stars).eachWithIndex { ptL, LU ->def NTc = "$hY/${ptL.name[0]}/${ptL.name}";def Za = ptL.order?: LU + wYT.size();wYT<<[wA:ptL.name,JY:ptL.character,fR:Za,NTc:"${NTc}/folder.jpg"];if (hY) {def aOr = new File(NTc);if (!aOr.exists()) {aOr.mkdirs();system "curl", "-o", "${NTc}/folder.jpg", "https://image.tmdb.org/t/p/original${ptL.profile_path}"}}};def xK = iFO / target.nameWithoutExtension + ".nfo";XML(xK) {mkp.xmlDeclaration(A_w:"1.0",encoding:"utf-8",standalone:"yes");episodedetails {plot(tCp.overview);lockdata("false");dateadded(new Date().format("yyyy-MM-dd HH:mm:ss", TimeZone.getTimeZone("UTC")));PJg(t);originaltitle(localize."${languages[0]}".t);rating(rating);try {year(airdate.format("yyyy"))} catch (Exception err) {};uniqueid(type:"tmdb",value:episode.id, 'default': "true", episode.id);tmdbid(episode.id);if (Gnr?.imdb_id) {uniqueid(type:"imdb",value:Gnr.imdb_id, Gnr.imdb_id);imdbid(Gnr.imdb_id)};if (Gnr?.tvdb_id) {uniqueid(type:"tvdb",value:Gnr.tvdb_id, Gnr.tvdb_id);tvdbid(Gnr.tvdb_id)};try {runtime(runtime)} catch (Exception err) {runtime(minutes)};try {if (db.AniDB?.episode?.id) {uniqueid(type:"anidb",value:db.AniDB.episode.id, db.AniDB.episode.id);anidbid(db.AniDB.episode.id)}} catch (Exception err) {};try {if (fv) {uniqueid(type:"tvmaze",value:fv, fv);tvmazeid(fv)}} catch (Exception err) {};if (Je.exists()) {art {poster(vQ)}};wYT.each { _RO ->actor {name(_RO.wA);role(_RO.JY);sortorder(_RO.fR);if (hY) { thumb(_RO.NTc) }}};showtitle(n);episode(alc);season(bVT);try {aired(airdate.format("yyyy-MM-dd"))} catch (Exception err) {};fileinfo {streamdetails {target.mediaInfo.Video.each { OlQ ->video {def Hx = Float.parseFloat(OlQ.'Duration');codec(OlQ.'Format');micodec(OlQ.'Format');bitrate(OlQ.'BitRate');width(OlQ.'Width');height(OlQ.'Height');aspect(OlQ.'DisplayAspectRatio/String');aspectratio(OlQ.'DisplayAspectRatio/String');framerate(OlQ.'FrameRate');'default'(OlQ.'Default'=="Yes"?"True" : "False");forced(OlQ.'Forced'=="Yes"?"True" : "False");duration(OlQ.'Duration'?(int) Math.floor(Hx / 60000) : 0);durationinseconds(OlQ.'Duration'?(int) Math.floor(Hx / 1000) : 0)}};target.mediaInfo.Audio.each { Zeh ->audio {codec(Zeh.'Format');micodec(Zeh.'Format');language(Zeh.'Language/String3');channels(Zeh.'Channel(s)');samplingrate(Zeh.'SamplingRate');'default'(Zeh.'Default'=="Yes"?"True" : "False");forced(Zeh.'Forced'=="Yes"?"True" : "False")}};target.mediaInfo.Text.each { W_K ->subtitle {codec(W_K.'Format');micodec(W_K.'Format');width('0');height('0');language(W_K.'Language/String3');'default'(W_K.'Default'=="Yes"?"True" : "False");forced(W_K.'Forced'=="Yes"?"True" : "False")}}}}}}}